# Phase 03: Integration & Threading - Plan 01

## Objective
Merge logic (Phase 01) and UI (Phase 02). Add F8 hotkey listener and threading so UI stays responsive during recording/transcription/translation.

## Context
- Roadmap: `@../../ROADMAP.md` (Phase 03)
- Brief: `@../../BRIEF.md`
- Phase 01 Summary: `@../01-foundation/01-01-SUMMARY.md`
- Phase 02 Summary: `@../02-ui-skeleton/02-01-SUMMARY.md`

## Tasks

### Task 1: Hotkey Listener in Background Thread
- **Type:** Feature
- **Files:**
  - Create `main.py` (consolidating console_test.py logic)
- **Action:**
  1. Import `keyboard` library for global hotkey detection
  2. Create function `hotkey_listener()` that runs in background thread
  3. Listen for F8 press globally (even when app is minimized)
  4. When F8 pressed, set event flag to trigger recording
  5. When F8 released, set flag to stop recording
  6. Thread should not block UI
- **Verify:**
  - Background thread starts when app launches
  - F8 press detected (test with print statements)
  - Multiple F8 presses don't crash app
  - Thread gracefully stops on app exit
- **Done:** Hotkey listener works in background

### Task 2: Recording Triggered by F8
- **Type:** Feature
- **Files:**
  - Update `main.py`
- **Action:**
  1. When F8 pressed, call recording function from Phase 01
  2. Run recording in separate thread (not blocking UI)
  3. Update UI state: "Ready" → "Recording" (color red)
  4. When F8 released or silence detected, stop recording
  5. Handle edge cases: multiple F8 presses during recording (ignore)
- **Verify:**
  - Press F8 → app shows "Recording" in red
  - Release F8 → recording stops
  - UI remains responsive (can interact with window)
  - No crashes on rapid F8 presses
- **Done:** F8 triggers recording without blocking UI

### Task 3: Transcription & Translation in Worker Thread
- **Type:** Feature
- **Files:**
  - Update `main.py`
- **Action:**
  1. After recording stops, start new thread for STT + translation
  2. Update UI state: "Recording" → "Processing" (color yellow)
  3. Send audio to Google Speech API
  4. Translate result (if needed)
  5. UI remains responsive during processing
  6. Handle API errors gracefully (show error message in UI)
- **Verify:**
  - Press F8, speak, release → UI shows "Processing"
  - After ~3-5 seconds, processing completes
  - UI stays responsive (can close app during processing)
  - Errors displayed (not crashes)
- **Done:** STT and translation run in worker thread

### Task 4: Text Injection & State Management
- **Type:** Feature
- **Files:**
  - Update `main.py`
- **Action:**
  1. After transcription/translation complete, inject text with `pyautogui`
  2. Update UI state: "Processing" → "Ready" (color green)
  3. Implement simple state machine to prevent race conditions:
     - IDLE → RECORDING → PROCESSING → IDLE
     - Ignore F8 during PROCESSING
  4. Test text injection in a text editor
- **Verify:**
  - After processing, text appears at cursor position
  - UI returns to "Ready" state
  - F8 ignored during processing (prevents queue overflow)
  - Works in text editors (Notes, Word, etc.)
- **Done:** Text injection works end-to-end

### Task 5: Threading Cleanup & Error Handling
- **Type:** Feature
- **Files:**
  - Update `main.py`
- **Action:**
  1. Add graceful shutdown: all threads join on app close
  2. Add try/catch around critical sections (API calls, audio recording)
  3. Log errors to console (for debugging)
  4. Document thread safety assumptions
  5. Test rapid state changes (F8 spam, network errors during processing)
- **Verify:**
  - App closes cleanly (no hanging threads)
  - Errors don't crash app (shown in UI instead)
  - Logs help debug issues
- **Done:** Threading is clean and robust

## Verification (Overall)
- All 5 tasks complete
- `main.py` launches integrated app
- F8 hotkey detected globally
- Recording, transcription, translation work without blocking UI
- Text injected at cursor position
- App handles errors gracefully
- Clean shutdown

## Success Criteria
✅ F8 hotkey listener in background thread
✅ F8 triggers recording (UI shows "Recording" in red)
✅ UI responsive during recording and processing
✅ Transcription runs in worker thread
✅ Translation works (or graceful skip)
✅ Text injected at cursor position
✅ UI state machine prevents race conditions
✅ Graceful shutdown (threads joined)
✅ Errors shown in UI (not crashes)

## Output
Creates `03-01-SUMMARY.md` when complete with:
- Proof of F8 detection
- Screenshot of "Recording" and "Processing" states
- Test results: text injection in text editor
- Notes on threading and race condition handling
- Any API quirks or platform-specific issues
